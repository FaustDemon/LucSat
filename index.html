<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Diamond Tap – immersive</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
/* ===== RESET ===== */
* { box-sizing:border-box; margin:0; padding:0; }

html, body {
  width:100%;
  height:100%;
  font-family: Arial, sans-serif;
  background: radial-gradient(circle at top, #0b0f1a, #000);
  color:#fff;
  overflow:hidden;
}

/* ===== ROOT VIEWPORT ===== */
.app {
  height: var(--tg-vh, 100vh);
  display:flex;
  flex-direction:column;
}

/* ===== TOP BAR (IMMERSIVE) ===== */
.top {
  position: sticky;
  top: 0;
  z-index: 5;
  background: rgba(11,15,26,0.92);
  backdrop-filter: blur(6px);
  padding: 14px 0 12px;
  text-align:center;
}

#totalDiamonds {
  display:block;
  font-size:22px;
  font-weight:bold;
  margin-bottom:6px;
}

#level {
  font-size:26px;
  font-weight:bold;
  margin-bottom:8px;
}

.progress-container {
  width:80%;
  max-width:320px;
  margin:0 auto;
  background:#333;
  border-radius:12px;
  overflow:hidden;
  height:14px;
}

#progressBar {
  height:100%;
  width:0%;
  background: linear-gradient(90deg,#84fab0,#8fd3f4);
}

/* ===== TIMER ===== */
#timerContainer {
  display:none;
  text-align:center;
  margin-top:10px;
}

#timer {
  font-family:monospace;
  font-size:46px;
  color:#8fd3f4;
}

#timer.urgent {
  color:#ff69b4;
}

/* ===== MAIN ===== */
.main {
  flex:1;
  overflow-y:auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom:90px;
}

.section {
  display:none;
  min-height:100%;
  padding:16px;
}

.section.active {
  display:flex;
  flex-direction:column;
}

/* ===== TAP ===== */
.diamond-wrapper {
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
}

.diamond {
  width:120px;
  height:120px;
  background:linear-gradient(135deg,#8fd3f4,#84fab0);
  clip-path: polygon(50% 0%,90% 25%,100% 60%,50% 100%,0% 60%,10% 25%);
  animation:breathe 4s infinite ease-in-out;
  transform: scale(var(--hit,1));
}

@keyframes breathe {
  0%,100%{transform:scale(1)}
  50%{transform:scale(1.04)}
}

.bottom {
  margin-top:20px;
  text-align:center;
}

button {
  padding:14px 30px;
  font-size:18px;
  border-radius:14px;
  border:none;
  background:#1f6bff;
  color:#fff;
}

/* ===== MENU ===== */
#menu {
  position:fixed;
  bottom:0;
  width:100%;
  display:flex;
  justify-content:space-around;
  background: rgba(0,0,0,0.9);
  padding:10px 0;
}

.menu-btn {
  background:none;
  border:none;
  color:#fff;
  font-size:15px;
}

.menu-btn.active {
  color:#8fd3f4;
  font-weight:bold;
}

/* ===== CARDS ===== */
.card {
  background:#222;
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
  text-align:center;
}

/* ===== GRID ===== */
.grid {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
}

.cell {
  background:linear-gradient(135deg,#8fd3f4,#84fab0);
  border-radius:8px;
  color:#000;
  padding:14px 0;
  text-align:center;
}
</style>
</head>

<body>
<div class="app">

  <div class="top">
    <span id="totalDiamonds">0.000</span>
    <div id="level">LEVEL 1</div>
    <div class="progress-container"><div id="progressBar"></div></div>
    <div id="timerContainer"><div id="timer">00:05:00</div></div>
  </div>

  <div class="main">

    <div id="tapSection" class="section active">
      <div class="diamond-wrapper">
        <div id="diamond" class="diamond"></div>
      </div>
      <div class="bottom">
        <button id="tapBtn">TAP</button>
      </div>
    </div>

    <div id="xSection" class="section">
      <div class="card">Поле X</div>
      <div class="grid">
        ${Array.from({length:24},(_,i)=>`<div class="cell">${i+1}</div>`).join('')}
      </div>
    </div>

  </div>

  <div id="menu">
    <button class="menu-btn active" data-s="tapSection">TAP</button>
    <button class="menu-btn" data-s="xSection">X</button>
  </div>

</div>

<script>
/* ===== TELEGRAM IMMERSIVE ===== */
if (Telegram?.WebApp) {
  const tg = Telegram.WebApp;

  tg.ready();
  tg.expand();
  tg.setBackgroundColor('#000000');
  tg.setHeaderColor('#000000');

  const setVH = () => {
    document.documentElement.style.setProperty('--tg-vh', tg.viewportHeight + 'px');
  };

  setVH();
  tg.onEvent('viewportChanged', setVH);
}

/* ===== GAME LOGIC ===== */
const CONFIG = { tap:0.037, time:5000 };
let total = +localStorage.total || 0;
let lvl = +localStorage.lvl || 1;
let prog = +localStorage.prog || 0;

const td = document.getElementById('totalDiamonds');
const lvlEl = document.getElementById('level');
const bar = document.getElementById('progressBar');
const timer = document.getElementById('timer');
const tWrap = document.getElementById('timerContainer');
const diamond = document.getElementById('diamond');

function ui(){
  td.textContent = total.toFixed(3);
  lvlEl.textContent = 'LEVEL ' + lvl;
  bar.style.width = (prog%100) + '%';
  localStorage.total=total;
  localStorage.lvl=lvl;
  localStorage.prog=prog;
}
ui();

let active=false,start;

document.getElementById('tapBtn').onclick=()=>{
  if(active) return;
  active=true;
  tWrap.style.display='block';
  start=performance.now();
  tick();
};

function tick(){
  if(!active) return;
  const r = Math.max(CONFIG.time-(performance.now()-start),0);
  timer.textContent='00:'+String(Math.floor(r/1000)).padStart(2,'0');
  if(r<=0){active=false;tWrap.style.display='none';return;}
  requestAnimationFrame(tick);
}

document.body.onpointerdown=e=>{
  if(!active) return;
  total+=CONFIG.tap;
  prog+=CONFIG.tap;
  if(prog>=100){prog-=100;lvl++;}
  diamond.style.setProperty('--hit',1.08);
  ui();
};
document.body.onpointerup=()=>diamond.style.setProperty('--hit',1);

/* ===== MENU ===== */
document.querySelectorAll('.menu-btn').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(b.dataset.s).classList.add('active');
    document.querySelectorAll('.menu-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
  };
});
</script>
</body>
</html>

