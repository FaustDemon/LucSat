<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Diamond Tap</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  background: radial-gradient(circle at top, #0b0f1a, #000);
  color: #fff;
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100vh;
  touch-action: none;
  position: relative;
}

.top {
  margin-top: 20px;
  text-align: center;
  width: 100%;
  z-index: 2;
}

#level {
  font-size: 32px;
  font-weight: bold;
}

.progress-container {
  width: 80%;
  max-width: 300px;
  margin: 15px auto 0;
  background: #333;
  border-radius: 10px;
  overflow: hidden;
}

#progressBar {
  height: 12px;
  background: linear-gradient(90deg, #84fab0, #8fd3f4);
  width: 0%;
}

#progress {
  margin-top: 8px;
}

#timerContainer {
  position: absolute;
  top: 200px; /* –Ω–∏–∂–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
  width: 100%;
  text-align: center;
  display: none;
  pointer-events: none;
  z-index: 3;
}

#timer {
  font-family: 'Courier New', monospace;
  font-size: 56px;
  font-weight: bold;
  color: #8fd3f4;
  text-shadow: 0 0 10px rgba(143,211,244,0.5);
  animation: softBreathe 4s infinite ease-in-out;
}

#timer.urgent {
  color: #ff69b4;
  text-shadow: 0 0 15px rgba(255,105,180,0.7);
  animation: urgentBreathe 1.2s infinite ease-in-out;
}

@keyframes softBreathe {
  0% { opacity: 0.9; }
  50% { opacity: 1; }
  100% { opacity: 0.9; }
}

@keyframes urgentBreathe {
  0% { opacity: 0.95; }
  50% { opacity: 1; }
  100% { opacity: 0.95; }
}

.diamond-wrapper {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  width: 100%;
}

.diamond {
  width: 120px;
  height: 120px;
  background: linear-gradient(135deg, #8fd3f4, #84fab0);
  clip-path: polygon(50% 0%, 90% 25%, 100% 60%, 50% 100%, 0% 60%, 10% 25%);
  animation: breathe 3.8s ease-in-out infinite;
  transform: scale(var(--hit-scale, 1));
  transition: filter 0.12s;
}

@keyframes breathe {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.04); }
  100% { transform: scale(1); }
}

#tapArea {
  position: absolute;
  inset: 0;
  z-index: 5;
}

.bottom {
  margin-bottom: 30px;
}

button {
  padding: 14px 28px;
  font-size: 18px;
  border-radius: 12px;
  border: none;
  background: #1f6bff;
  color: #fff;
}

button:disabled {
  background: #444;
}

#menu {
  position: absolute;
  bottom: 0;
  width: 100%;
  display: flex;
  justify-content: space-around;
  background: rgba(0, 0, 0, 0.8);
  padding: 10px 0;
  z-index: 10;
}

.menu-btn {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
}

#upgradeSection, #farmSection {
  display: none;
  flex-direction: column;
  align-items: center;
  text-align: center;
  width: 100%;
  padding: 20px;
}

#upgradeSection h2, #farmSection h2 {
  margin-bottom: 20px;
}

.card {
  background: #333;
  padding: 15px;
  margin: 10px;
  border-radius: 10px;
  width: 80%;
  text-align: left;
}

.card button {
  margin-top: 10px;
  padding: 10px;
  background: #1f6bff;
  border: none;
  color: #fff;
  border-radius: 8px;
}

.card button:disabled {
  background: #444;
}
</style>
</head>

<body>

<div class="top">
  <div style="font-size:24px;margin-bottom:10px;">
    <span id="totalDiamonds">0.000</span> üíé
  </div>
  <div id="level">LEVEL 1</div>

  <div class="progress-container">
    <div id="progressBar"></div>
  </div>
  <div id="progress">0.000 / 100</div>
</div>

<div id="timerContainer">
  <div id="timer">00:05:00</div>
</div>

<div class="diamond-wrapper" id="tapSection">
  <div id="diamond" class="diamond"></div>
  <div id="tapArea"></div>
</div>

<div id="upgradeSection">
  <h2>–ü—Ä–æ–∫–∞—á–∫–∞</h2>
  <div class="card">
    <h3>–ö–∏—Ä–∫–∞</h3>
    <p>–£—Ä–æ–≤–µ–Ω—å: <span id="pickaxeLevel">1</span></p>
    <p>–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–ø–≥—Ä–µ–π–¥–∞: <span id="pickaxeCost">10</span> üíé</p>
    <button id="upgradePickaxe">–ê–ø–≥—Ä–µ–π–¥</button>
  </div>
  <div class="card">
    <h3>–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–∞ –¥–æ–±—ã—á—É</h3>
    <p>–£—Ä–æ–≤–µ–Ω—å: <span id="licenseLevel">1</span></p>
    <p>–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–ø–≥—Ä–µ–π–¥–∞: <span id="licenseCost">20</span> üíé</p>
    <button id="upgradeLicense">–ê–ø–≥—Ä–µ–π–¥</button>
  </div>
  <!-- –î–æ–±–∞–≤—å –±–æ–ª—å—à–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ -->
</div>

<div id="farmSection">
  <h2>–§–∞—Ä–º</h2>
  <p>–°–ª–∏–≤–∞–π –∞–ª–º–∞–∑—ã, —Ä–∞–∑–≤–æ–¥–∏ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –∏ —É—Å—Ç—Ä–∞–∏–≤–∞–π –¥—É—ç–ª–∏!</p>
  <div class="card">
    <h3>–ö—Ä–∏—Å—Ç–∞–ª–ª</h3>
    <p>–£—Ä–æ–≤–µ–Ω—å: <span id="crystalLevel">1</span></p>
    <p>–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥: <span id="passiveIncome">0.001</span> / —Å–µ–∫</p>
    <button id="feedCrystal">–ö–æ—Ä–º–∏—Ç—å (5 üíé)</button>
  </div>
  <button id="mergeCrystals">–°–ª–∏—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª—ã</button>
  <button id="duelCrystals">–î—É—ç–ª—å</button>
</div>

<div id="menu">
  <button class="menu-btn" onclick="showSection('tapSection')">–¢–∞–ø</button>
  <button class="menu-btn" onclick="showSection('upgradeSection')">–ü—Ä–æ–∫–∞—á–∫–∞</button>
  <button class="menu-btn" onclick="showSection('farmSection')">–§–∞—Ä–º</button>
</div>

<script>
const tapArea = document.getElementById('tapArea');
const tapBtn = document.getElementById('tapBtn');
const diamond = document.getElementById('diamond');
const totalDiamondsText = document.getElementById('totalDiamonds');
const levelText = document.getElementById('level');
const progressText = document.getElementById('progress');
const progressBar = document.getElementById('progressBar');
const timerContainer = document.getElementById('timerContainer');
const timer = document.getElementById('timer');

let totalDiamonds = parseFloat(localStorage.getItem('totalDiamonds')) || 0;
let level = parseInt(localStorage.getItem('level')) || 1;
let progress = parseFloat(localStorage.getItem('progress')) || 0;

let pickaxeLevel = parseInt(localStorage.getItem('pickaxeLevel')) || 1;
let licenseLevel = parseInt(localStorage.getItem('licenseLevel')) || 1;

let crystalLevel = parseInt(localStorage.getItem('crystalLevel')) || 1;
let passiveIncome = 0.001 * crystalLevel;

const tapValue = 0.066;
const diamondsPerLevel = 100;
const sessionDuration = 5000;
const urgentThreshold = 1000;
const maxTouches = 5;

let active = false;
let startTime = 0;
let timerInterval = null;
const activePointers = new Set();

const pickaxeCostBase = 10;
const licenseCostBase = 20;

const upgradePickaxe = document.getElementById('upgradePickaxe');
const pickaxeLevelSpan = document.getElementById('pickaxeLevel');
const pickaxeCostSpan = document.getElementById('pickaxeCost');

const upgradeLicense = document.getElementById('upgradeLicense');
const licenseLevelSpan = document.getElementById('licenseLevel');
const licenseCostSpan = document.getElementById('licenseCost');

const feedCrystal = document.getElementById('feedCrystal');
const crystalLevelSpan = document.getElementById('crystalLevel');
const passiveIncomeSpan = document.getElementById('passiveIncome');

const mergeCrystals = document.getElementById('mergeCrystals');
const duelCrystals = document.getElementById('duelCrystals');

function updateUI() {
  totalDiamondsText.innerText = totalDiamonds.toFixed(3);
  levelText.innerText = `LEVEL ${level}`;
  progressText.innerText = `${progress.toFixed(3)} / ${diamondsPerLevel}`;
  progressBar.style.width = `${(progress / diamondsPerLevel) * 100}%`;

  pickaxeLevelSpan.innerText = pickaxeLevel;
  licenseLevelSpan.innerText = licenseLevel;
  pickaxeCostSpan.innerText = (pickaxeCostBase * pickaxeLevel);
  licenseCostSpan.innerText = (licenseCostBase * licenseLevel);

  crystalLevelSpan.innerText = crystalLevel;
  passiveIncomeSpan.innerText = passiveIncome.toFixed(3);

  localStorage.setItem('totalDiamonds', totalDiamonds);
  localStorage.setItem('level', level);
  localStorage.setItem('progress', progress);
  localStorage.setItem('pickaxeLevel', pickaxeLevel);
  localStorage.setItem('licenseLevel', licenseLevel);
  localStorage.setItem('crystalLevel', crystalLevel);
}

updateUI();

function showSection(sectionId) {
  document.getElementById('tapSection').style.display = 'none';
  document.getElementById('upgradeSection').style.display = 'none';
  document.getElementById('farmSection').style.display = 'none';

  document.getElementById(sectionId).style.display = 'block';
}

function startSession() {
  if (active) return;
  active = true;

  tapBtn.disabled = true;
  timerContainer.style.display = 'block';
  timer.classList.remove('urgent');

  startTime = performance.now();
  timerInterval = setInterval(updateTimer, 30);

  tapArea.addEventListener('pointerdown', onPointerDown);
  tapArea.addEventListener('pointerup', onPointerUp);
  tapArea.addEventListener('pointercancel', onPointerUp);
}

function endSession() {
  active = false;
  tapBtn.disabled = false;
  timerContainer.style.display = 'none';
  activePointers.clear();
  diamond.style.setProperty('--hit-scale', 1);

  clearInterval(timerInterval);

  tapArea.removeEventListener('pointerdown', onPointerDown);
  tapArea.removeEventListener('pointerup', onPointerUp);
  tapArea.removeEventListener('pointercancel', onPointerUp);
}

function updateTimer() {
  const remaining = Math.max(sessionDuration - (performance.now() - startTime), 0);
  const s = Math.floor(remaining / 1000);
  const ms = Math.floor((remaining % 1000) / 10);

  timer.innerText = `00:${s.toString().padStart(2,'0')}:${ms.toString().padStart(2,'0')}`;

  if (remaining <= urgentThreshold) timer.classList.add('urgent');
  if (remaining <= 0) endSession();
}

function onPointerDown(e) {
  if (!active) return;
  if (activePointers.size >= maxTouches) return;

  activePointers.add(e.pointerId);

  const effectiveTouches = Math.min(activePointers.size, maxTouches);
  const gain = tapValue * effectiveTouches;  // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ—Ç –ø–∞–ª—å—Ü–µ–≤

  totalDiamonds += gain;
  progress += gain;

  if (progress >= diamondsPerLevel) {
    progress -= diamondsPerLevel;
    level++;
  }

  diamond.style.setProperty('--hit-scale', 1 + effectiveTouches * 0.04);  // –õ—ë–≥–∫–∏–π –∞–ø–≥—Ä–µ–π–¥ scale –æ—Ç –ø–∞–ª—å—Ü–µ–≤
  updateUI();
}

function onPointerUp(e) {
  activePointers.delete(e.pointerId);
  const effectiveTouches = Math.min(activePointers.size, maxTouches);
  diamond.style.setProperty('--hit-scale', 1 + effectiveTouches * 0.04);
}

tapBtn.onclick = startSession;

const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();
tg.disableVerticalSwipes();

// –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –æ—Ç –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ (–∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É)
setInterval(() => {
  totalDiamonds += passiveIncome;
  progress += passiveIncome;
  if (progress >= diamondsPerLevel) {
    progress -= diamondsPerLevel;
    level++;
  }
  updateUI();
}, 1000);

// –ê–ø–≥—Ä–µ–π–¥ –∫–∏—Ä–∫–∏
upgradePickaxe.onclick = () => {
  const cost = pickaxeCostBase * pickaxeLevel;
  if (totalDiamonds >= cost) {
    totalDiamonds -= cost;
    pickaxeLevel++;
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç tapValue –Ω–∞ 0.01 –∑–∞ —É—Ä–æ–≤–µ–Ω—å
    tapValue += 0.01;
    updateUI();
  }
};

// –ê–ø–≥—Ä–µ–π–¥ –ª–∏—Ü–µ–Ω–∑–∏–∏
upgradeLicense.onclick = () => {
  const cost = licenseCostBase * licenseLevel;
  if (totalDiamonds >= cost) {
    totalDiamonds -= cost;
    licenseLevel++;
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
    passiveIncome += 0.001;
    updateUI();
  }
};

// –ö–æ—Ä–º–∏—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª
feedCrystal.onclick = () => {
  if (totalDiamonds >= 5) {
    totalDiamonds -= 5;
    crystalLevel++;
    passiveIncome = 0.001 * crystalLevel;
    updateUI();
  }
};

// –°–ª–∏—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª—ã (merge) ‚Äî –ø—Ä–æ—Å—Ç–∞—è —Å–∏–º—É–ª—è—Ü–∏—è
mergeCrystals.onclick = () => {
  // –õ–æ–≥–∏–∫–∞ merge: –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —Å–ª–∏–≤–∞–µ—Ç 2 –∫—Ä–∏—Å—Ç–∞–ª–ª–∞ –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞
  if (crystalLevel >= 2) {
    crystalLevel += 1;  // –ê–ø–ø–≥—Ä–µ–π–¥
    passiveIncome = 0.001 * crystalLevel;
    updateUI();
    alert('–ö—Ä–∏—Å—Ç–∞–ª–ª—ã —Å–ª–∏—Ç—ã! –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω.');
  } else {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –¥–ª—è —Å–ª–∏—è–Ω–∏—è.');
  }
};

// –î—É—ç–ª—å ‚Äî –ø—Ä–æ—Å—Ç–∞—è —Å–∏–º—É–ª—è—Ü–∏—è
duelCrystals.onclick = () => {
  // –°–∏–º—É–ª—è—Ü–∏—è –¥—É—ç–ª–∏: —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à
  const win = Math.random() > 0.5;
  if (win) {
    totalDiamonds += 10;
    alert('–ü–æ–±–µ–¥–∞ –≤ –¥—É—ç–ª–∏! +10 üíé');
  } else {
    alert('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ –≤ –¥—É—ç–ª–∏. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞!');
  }
  updateUI();
};

// –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–ø –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
showSection('tapSection');

const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();
tg.disableVerticalSwipes();
</script>

</body>
  </html>
