<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Diamond Tap - v1.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  /* --- Reset & body --- */
  * { box-sizing: border-box; margin:0; padding:0; }
  html, body { height:100%; font-family: Arial, sans-serif; background: radial-gradient(circle at top, #0b0f1a, #000); color:#fff; display:flex; flex-direction:column; }

  /* --- Header --- */
  .top {
    position: fixed;
    top:0; left:0; width:100%;
    background: rgba(11,15,26,0.85);
    padding: 12px 0;
    text-align:center;
    z-index:10;
  }
  .top #totalDiamonds { font-size:22px; font-weight:bold; margin-bottom:6px; display:block; }
  .top #level { font-size:28px; font-weight:bold; margin-bottom:8px; }
  .progress-container { width:80%; max-width:320px; margin:0 auto; background:#333; border-radius:12px; overflow:hidden; height:14px; }
  #progressBar { height:100%; width:0%; background: linear-gradient(90deg, #84fab0, #8fd3f4); transition: width 0.2s; }

  /* --- Timer --- */
  #timerContainer { 
    position:fixed; 
    top:90px; 
    width:100%; 
    text-align:center; 
    pointer-events:none; 
    z-index:11; 
    display:none; 
  }
  #timer { font-family:'Courier New', monospace; font-size:52px; font-weight:bold; color:#8fd3f4; text-shadow:0 0 12px rgba(143,211,244,0.5); animation: softBreathe 4s infinite ease-in-out; }
  #timer.urgent { color:#ff69b4; text-shadow:0 0 16px rgba(255,105,180,0.7); animation: urgentBreathe 1.2s infinite ease-in-out; }
  @keyframes softBreathe { 0%,100%{opacity:0.9} 50%{opacity:1} }
  @keyframes urgentBreathe { 0%,100%{opacity:0.95} 50%{opacity:1} }

  /* --- Main sections --- */
  .main { flex:1; display:flex; flex-direction:column; margin-top:160px; margin-bottom:70px; }
  .section { 
    flex:1; 
    display:none; 
    flex-direction:column; 
    align-items:center; 
    justify-content:flex-start; 
    padding:12px; 
    width:100%; 
    overflow-y: auto; 
  }

  /* --- Diamond TAP --- */
  .diamond-wrapper { flex:1; display:flex; align-items:center; justify-content:center; width:100%; }
  .diamond { width:120px; height:120px; background:linear-gradient(135deg, #8fd3f4, #84fab0); clip-path: polygon(50% 0%,90% 25%,100% 60%,50% 100%,0% 60%,10% 25%); animation:breathe 3.8s ease-in-out infinite; transform:scale(var(--hit-scale,1)); transition: transform 0.12s; }
  @keyframes breathe {0%,100%{transform:scale(1);}50%{transform:scale(1.04);}}

  .bottom { margin-top:16px; }
  button { padding:12px 28px; font-size:18px; border-radius:12px; border:none; background:#1f6bff; color:#fff; cursor:pointer; }
  button:disabled { background:#444; }

  /* --- Menu --- */
  #menu { position:fixed; bottom:0; width:100%; display:flex; justify-content:space-around; background: rgba(0,0,0,0.85); padding:8px 0; z-index:12; }
  .menu-btn { background:transparent; border:none; color:#fff; font-size:16px; cursor:pointer; padding:8px; }
  .menu-btn.active { color:#8fd3f4; font-weight:bold; }

  /* --- Cards --- */
  .card { background:#222; border-radius:10px; padding:12px; margin:8px 0; width:90%; max-width:340px; text-align:center; }
  .card button { margin-top:10px; width:100%; }

  /* --- Section X grid --- */
  #xSection .grid { 
    display: none; /* <- скрыт по умолчанию */
    grid-template-columns: repeat(4, 1fr); 
    grid-auto-rows: minmax(60px, 1fr); /* квадратные, можно менять minmax для высоты */
    gap:6px; 
    width:100%; 
    max-width:360px; 
  }
  #xSection .grid .cell {
    background: linear-gradient(135deg, #8fd3f4, #84fab0);
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
    color:#000;
  }
</style>
</head>
<body>

<!-- Top Info -->
<div class="top">
  <span id="totalDiamonds">0.000</span>
  <div id="level">LEVEL 1</div>
  <div class="progress-container"><div id="progressBar"></div></div>
</div>

<!-- Timer -->
<div id="timerContainer"><div id="timer">00:05:00</div></div>

<!-- Main Sections -->
<div class="main">
  <!-- TAP -->
  <div id="tapSection" class="section" style="display:flex;">
    <div class="diamond-wrapper"><div id="diamond" class="diamond"></div></div>
    <div class="bottom"><button id="tapBtn">TAP</button></div>
  </div>

  <!-- Upgrade -->
  <div id="upgradeSection" class="section">
    <h2>Прокачка</h2>
    <div class="card"><p>Coming Soon</p></div>
  </div>

  <!-- X Section -->
  <div id="xSection" class="section">
    <div class="card">
      <p>Поле для будущих ячеек</p>
    </div>
    <div class="grid">
      <div class="cell">1</div><div class="cell">2</div><div class="cell">3</div><div class="cell">4</div>
      <div class="cell">5</div><div class="cell">6</div><div class="cell">7</div><div class="cell">8</div>
      <div class="cell">9</div><div class="cell">10</div><div class="cell">11</div><div class="cell">12</div>
      <div class="cell">13</div><div class="cell">14</div><div class="cell">15</div><div class="cell">16</div>
      <div class="cell">17</div><div class="cell">18</div><div class="cell">19</div><div class="cell">20</div>
      <div class="cell">21</div><div class="cell">22</div><div class="cell">23</div><div class="cell">24</div>
    </div>
  </div>

  <!-- Farm -->
  <div id="farmSection" class="section">
    <h2>Фарм</h2>
    <div class="card"><p>Coming Soon</p></div>
  </div>

  <!-- Friends -->
  <div id="friendsSection" class="section">
    <h2>Друзья</h2>
    <div class="card"><p>Здесь будут ваши друзья</p><button id="addFriend">Добавить друга</button></div>
  </div>
</div>

<!-- Menu -->
<div id="menu">
  <button class="menu-btn active" data-section="tapSection">TAP</button>
  <button class="menu-btn" data-section="upgradeSection">Прокачка</button>
  <button class="menu-btn" data-section="xSection">X</button>
  <button class="menu-btn" data-section="farmSection">Фарм</button>
  <button class="menu-btn" data-section="friendsSection">Друзья</button>
</div>

<script>
const CONFIG = { tapValue:0.037, sessionDuration:5000, maxTouches:5, urgentThreshold:1000 };
let totalDiamonds = parseFloat(localStorage.getItem('totalDiamonds')) || 0;
let level = parseInt(localStorage.getItem('level')) || 1;
let progress = parseFloat(localStorage.getItem('progress')) || 0;
const diamondsPerLevel = 100;
let active=false, startTime=0, timerInterval=null;
const activePointers = new Set();

const tapBtn=document.getElementById('tapBtn');
const diamond=document.getElementById('diamond');
const totalDiamondsText=document.getElementById('totalDiamonds');
const levelText=document.getElementById('level');
const progressBar=document.getElementById('progressBar');
const timer=document.getElementById('timer');
const timerContainer=document.getElementById('timerContainer');

function updateUI(){
  totalDiamondsText.innerText=totalDiamonds.toFixed(3);
  levelText.innerText=`LEVEL ${level}`;
  progressBar.style.width=`${Math.min((progress/diamondsPerLevel)*100,100)}%`;
  localStorage.setItem('totalDiamonds',totalDiamonds);
  localStorage.setItem('level',level);
  localStorage.setItem('progress',progress);
}
updateUI();

document.querySelectorAll('.menu-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(active) return;
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
    const sec = document.getElementById(btn.dataset.section);
    sec.style.display='flex';
    btn.classList.add('active');

    // Показываем грид только при открытии секции X
    if(btn.dataset.section === 'xSection'){
      const grid = sec.querySelector('.grid');
      grid.style.display='grid';
    }
  });
});

function startSession(){
  if(active) return;
  active=true;
  tapBtn.disabled=true;
  timerContainer.style.display='block';
  timer.classList.remove('urgent');
  startTime=performance.now();
  timerInterval=setInterval(updateTimer,50);
  activePointers.clear();
}

function endSession(){
  active=false;
  tapBtn.disabled=false;
  timerContainer.style.display='none';
  activePointers.clear();
  diamond.style.setProperty('--hit-scale',1);
  clearInterval(timerInterval);
}

function updateTimer(){
  const remaining = Math.max(CONFIG.sessionDuration - (performance.now() - startTime), 0);
  const minutes = Math.floor(remaining / 60000);
  const seconds = Math.floor((remaining % 60000) / 1000);
  const ms = Math.floor((remaining % 1000) / 10);
  timer.innerText = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}:${ms.toString().padStart(2,'0')}`;
  if(remaining <= CONFIG.urgentThreshold) timer.classList.add('urgent');
  if(remaining <= 0) endSession();
}

document.body.addEventListener('pointerdown',e=>{
  if(!active) return;
  e.preventDefault();
  if(!activePointers.has(e.pointerId)){
    activePointers.add(e.pointerId);
    const effectiveTouches=Math.min(activePointers.size,CONFIG.maxTouches);
    const gain=CONFIG.tapValue*effectiveTouches;
    totalDiamonds+=gain; progress+=gain;
    if(progress>=diamondsPerLevel){progress-=diamondsPerLevel; level++;}
    diamond.style.setProperty('--hit-scale',1+effectiveTouches*0.06);
    updateUI();
  }
});

document.body.addEventListener('pointerup',e=>{
  activePointers.delete(e.pointerId);
  const effectiveTouches=Math.min(activePointers.size,CONFIG.maxTouches);
  diamond.style.setProperty('--hit-scale', active ? 1+effectiveTouches*0.06 : 1);
});

tapBtn.onclick=startSession;

// Telegram WebApp
if(window.Telegram && window.Telegram.WebApp){
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();
  tg.disableVerticalSwipes();
  if (tg.showHeader) tg.showHeader(false);
}
</script>
</body>
</html>

